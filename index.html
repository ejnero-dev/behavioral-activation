<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorregistro de Activaci√≥n Conductual</title>

    <!-- PWA Meta Tags -->
    <meta name="description"
        content="Autorregistro de Activaci√≥n Conductual en base a valores - Herramienta para terapia psicol√≥gica">
    <meta name="author" content="Emilio Neva">
    <meta name="theme-color" content="#667eea">
    <meta name="color-scheme" content="light">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ActConductual">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons para iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .week-selector {
            flex: 1;
            min-width: 200px;
        }

        .week-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .week-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .week-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .week-btn:hover {
            background: #5568d3;
        }

        .week-btn.danger {
            background: #ef4444;
        }

        .week-btn.danger:hover {
            background: #dc2626;
        }

        .week-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .valor-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white !important;
            color: #333 !important;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .intro-text {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .action-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .action-name {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            background-color: white !important;
            color: #333 !important;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        td.label-cell {
            background: #f0f0f0;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            background-color: white !important;
            color: #333 !important;
            -webkit-appearance: none;
            appearance: none;
            min-height: 36px;
            box-sizing: border-box;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            background-color: #f8f9ff !important;
        }

        textarea.comentarios {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 13px;
            overflow-y: hidden;
            font-family: inherit;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .add-btn:hover {
            background: #5568d3;
        }

        .autosave-info {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #10b981;
            font-weight: 600;
        }

        .footer-note {
            margin-top: 20px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .export-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #059669;
        }

        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .install-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        .install-btn:active {
            transform: scale(0.95);
        }

        .comentarios-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 18px;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 4px 2px;
            }

            /* Inputs m√°s grandes en m√≥vil */
            input[type="number"] {
                padding: 10px 2px;
                font-size: 18px;
                min-height: 40px;
            }

            /* Ocultar columna de comentarios en m√≥vil */
            th.comentarios-col,
            td.comentarios-col {
                display: none;
            }

            /* Mostrar comentarios debajo de la tabla */
            .comentarios-mobile {
                display: block;
                margin-top: 15px;
            }

            .comentarios-mobile label {
                display: block;
                font-weight: 600;
                color: #555;
                margin-bottom: 8px;
                font-size: 14px;
            }

            .comentarios-mobile textarea {
                width: 100%;
                min-height: 100px;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background-color: white !important;
                color: #333 !important;
                font-family: inherit;
            }
        }

        .week-section {
            margin-bottom: 40px;
            page-break-after: always;
        }

        .week-section:last-child {
            page-break-after: auto;
        }

        .week-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        #print-container {
            display: none;
        }

        .app-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
        }

        .privacy-notice {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            margin-bottom: 20px;
            font-size: 14px;
            color: #059669;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .privacy-notice .lock-icon {
            font-size: 18px;
        }

        .developer-info {
            margin-bottom: 15px;
        }

        .developer-info .name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .contact-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .contact-link:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .contact-link .icon {
            font-size: 18px;
        }

        .footer-meta {
            font-size: 12px;
            color: #666;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .footer-meta a {
            color: #667eea;
            text-decoration: none;
        }

        .footer-meta a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .contact-links {
                flex-direction: column;
                gap: 10px;
            }

            .app-footer {
                margin-top: 30px;
                padding-top: 20px;
            }

            .privacy-notice {
                font-size: 13px;
                padding: 12px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                display: none;
            }

            #print-container {
                display: block !important;
                max-width: 100%;
                padding: 20px;
            }

            .add-btn,
            .delete-btn,
            .export-section,
            .week-navigation,
            .autosave-info,
            .app-footer,
            .install-prompt {
                display: none;
            }

            textarea.comentarios {
                border: none;
                overflow: visible;
                height: auto;
                resize: none;
                page-break-inside: avoid;
                white-space: pre-wrap;
            }

            .action-card {
                page-break-inside: avoid;
            }

            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .week-section {
                page-break-after: always;
            }

            .week-section:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Autorregistro de Activaci√≥n Conductual en base a valores</h1>

        <!-- Banner de instalaci√≥n -->
        <div id="install-prompt" class="install-prompt">
            <p style="margin: 0 0 5px 0; font-weight: 600;">üì± Instala esta app en tu m√≥vil</p>
            <p style="margin: 0 0 10px 0; font-size: 13px;">Accede m√°s r√°pido y √∫sala sin conexi√≥n</p>
            <button id="install-button" class="install-btn">‚¨áÔ∏è Instalar App</button>
        </div>

        <div class="week-navigation">
            <div class="week-selector">
                <select id="week-selector" onchange="changeWeek()">
                    <!-- Las opciones se generar√°n din√°micamente -->
                </select>
            </div>
            <div class="week-buttons">
                <button class="week-btn" onclick="addNewWeek()">‚ûï Semana Siguiente</button>
                <button class="week-btn" onclick="addPreviousWeek()">‚¨ÖÔ∏è Semana Anterior</button>
                <button class="week-btn danger" onclick="deleteWeek()">üóëÔ∏è Eliminar Semana</button>
            </div>
        </div>

        <div class="valor-section">
            <label>Valor:</label>
            <input type="text" id="valor" placeholder="Escribe el valor que guiar√° tus acciones esta semana">
        </div>

        <p class="intro-text">Esta semana programo las siguientes acciones:</p>

        <div id="actions-container"></div>

        <button class="add-btn" onclick="addAction()">
            <span>‚ûï</span> Agregar Acci√≥n
        </button>

        <div class="export-section">
            <button class="export-btn" onclick="exportBackup()">üì• Exportar Backup</button>
            <button class="export-btn" onclick="importBackup()">üì§ Importar Backup</button>
            <button class="export-btn" onclick="printAllWeeks()">üñ®Ô∏è Imprimir Todas las Semanas</button>
            <button class="export-btn" style="background: #6366f1;" onclick="showStats()">üìä Ver Progreso</button>
        </div>

        <p class="autosave-info">
            ‚úì Tus cambios se guardan autom√°ticamente
        </p>

        <p class="footer-note">
            * Eval√∫a cada d√≠a del 0 al 10 el placer experimentado y la sensaci√≥n de logro al realizar cada acci√≥n
        </p>

        <!-- Footer Profesional -->
        <footer class="app-footer">
            <div class="privacy-notice">
                <span class="lock-icon">üîí</span>
                <span>Tus datos nunca salen de tu dispositivo - Privacidad garantizada</span>
            </div>

            <div class="developer-info">
                <div class="name">Desarrollado por Emilio Neva</div>
                <div class="contact-links">
                    <a href="mailto:ejnero.dev@gmail.com" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üìß</span>
                        <span>ejnero.dev@gmail.com</span>
                    </a>
                    <a href="https://www.linkedin.com/in/emilioneva/" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üíº</span>
                        <span>LinkedIn</span>
                    </a>
                    <a href="https://github.com/ejnero-dev/behavioral-activation" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üíª</span>
                        <span>GitHub</span>
                    </a>
                </div>
            </div>

            <div class="footer-meta">
                ¬© 2025 Emilio Neva - <a href="https://github.com/ejnero-dev/behavioral-activation/blob/main/LICENSE"
                    target="_blank" rel="noopener noreferrer">Licencia MIT</a> - v1.0
            </div>
        </footer>
    </div>

    <!-- Contenedor para impresi√≥n de todas las semanas -->
    <div id="print-container"></div>

    <!-- Modal de Estad√≠sticas -->
    <dialog id="stats-modal"
        style="border: none; border-radius: 12px; padding: 20px; max-width: 600px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #333;">Mi Progreso</h2>
            <button onclick="document.getElementById('stats-modal').close()"
                style="border: none; background: none; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Promedio semanal de Placer y Logro (0-10)</p>

        <!-- Contenedor del gr√°fico SVG -->
        <div id="chart-container"
            style="width: 100%; height: 250px; background: #f9f9f9; border-radius: 8px; position: relative; border: 1px solid #eee;">
            <!-- El SVG se inyectar√° aqu√≠ -->
        </div>

        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 12px;">
            <div style="display: flex; align-items: center; gap: 5px;"><span
                    style="width: 10px; height: 10px; background: #667eea; border-radius: 50%;"></span> Placer</div>
            <div style="display: flex; align-items: center; gap: 5px;"><span
                    style="width: 10px; height: 10px; background: #10b981; border-radius: 50%;"></span> Logro</div>
        </div>
    </dialog>

    <script>
        let weeks = [];
        let currentWeekId = null;
        let weekCounter = 1;
        let actionCounter = 1;

        function initApp() {
            // Cargar datos guardados si existen
            const savedData = localStorage.getItem('activacionConductual');
            if (savedData) {
                const data = JSON.parse(savedData);

                // Migrar datos antiguos al nuevo formato si es necesario
                if (data.actions && !data.weeks) {
                    // Formato antiguo, migrar
                    weeks = [{
                        id: 1,
                        startDate: getMonday(new Date()),
                        valor: data.valor || '',
                        actions: data.actions || []
                    }];
                    currentWeekId = 1;
                    weekCounter = 2;
                    actionCounter = data.actionCounter || 1;
                } else {
                    // Formato nuevo
                    weeks = data.weeks || [];
                    currentWeekId = data.currentWeekId || null;
                    weekCounter = data.weekCounter || 1;
                    actionCounter = data.actionCounter || 1;
                }
            }

            // Si no hay semanas, crear una por defecto
            if (weeks.length === 0) {
                weeks.push(createNewWeek());
                currentWeekId = weeks[0].id;
            }

            // Si currentWeekId no est√° establecido o no es v√°lido, usar la primera semana
            if (!currentWeekId || !weeks.find(w => w.id === currentWeekId)) {
                currentWeekId = weeks[0].id;
            }

            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return d.toISOString().split('T')[0];
        }

        function formatWeekRange(startDate) {
            const start = new Date(startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);

            const formatDate = (d) => {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            };

            return `Semana del ${formatDate(start)} al ${formatDate(end)}`;
        }

        function weekExists(startDate) {
            return weeks.some(w => w.startDate === startDate);
        }

        function getNextWeekDate() {
            if (weeks.length === 0) {
                return getMonday(new Date());
            }
            // Encontrar la semana m√°s reciente
            const mostRecentWeek = weeks.reduce((latest, week) => {
                return new Date(week.startDate) > new Date(latest.startDate) ? week : latest;
            });
            // Calcular siguiente lunes (+ 7 d√≠as)
            const nextDate = new Date(mostRecentWeek.startDate);
            nextDate.setDate(nextDate.getDate() + 7);
            return nextDate.toISOString().split('T')[0];
        }

        function getPreviousWeekDate() {
            if (weeks.length === 0) {
                // Si no hay semanas, crear una semana atr√°s desde hoy
                const prevDate = new Date();
                const day = prevDate.getDay();
                const diff = prevDate.getDate() - day + (day === 0 ? -6 : 1) - 7;
                prevDate.setDate(diff);
                return prevDate.toISOString().split('T')[0];
            }
            // Encontrar la semana m√°s antigua
            const oldestWeek = weeks.reduce((oldest, week) => {
                return new Date(week.startDate) < new Date(oldest.startDate) ? week : oldest;
            });
            // Calcular lunes anterior (- 7 d√≠as)
            const prevDate = new Date(oldestWeek.startDate);
            prevDate.setDate(prevDate.getDate() - 7);
            return prevDate.toISOString().split('T')[0];
        }

        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback para navegadores muy antiguos
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function createNewWeek() {
            return {
                id: generateUUID(),
                startDate: getMonday(new Date()),
                valor: '',
                actions: [createNewAction()]
            };
        }

        function createNewAction() {
            // Calculamos el n√∫mero de acci√≥n solo para el nombre visible, no para el ID
            const currentActions = getCurrentWeek() ? getCurrentWeek().actions.length + 1 : 1;
            return {
                id: generateUUID(),
                name: `Acci√≥n ${currentActions}`,
                placer: { L: '', M: '', X: '', J: '', V: '', S: '', D: '' },
                logro: { L: '', M: '', X: '', J: '', V: '', S: '', D: '' },
                comentarios: ''
            };
        }

        function getCurrentWeek() {
            return weeks.find(w => w.id === currentWeekId);
        }

        function addAction() {
            const week = getCurrentWeek();
            if (week) {
                week.actions.push(createNewAction());
                renderActions();
                autoSave();
            }
        }

        function removeAction(id) {
            const week = getCurrentWeek();
            if (week && week.actions.length > 1) {
                week.actions = week.actions.filter(a => a.id !== id);
                renderActions();
                autoSave();
            }
        }

        function addNewWeek() {
            const nextWeekDate = getNextWeekDate();

            // Validar que no exista esa semana
            if (weekExists(nextWeekDate)) {
                const formattedRange = formatWeekRange(nextWeekDate);
                alert(`‚ö†Ô∏è La semana "${formattedRange}" ya existe.\n\nNo se pueden crear semanas duplicadas.`);
                return;
            }

            const newWeek = {
                id: weekCounter++,
                startDate: nextWeekDate,
                valor: '',
                actions: [createNewAction()]
            };

            weeks.push(newWeek);
            currentWeekId = newWeek.id;
            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        function addPreviousWeek() {
            const prevWeekDate = getPreviousWeekDate();

            // Validar que no exista esa semana
            if (weekExists(prevWeekDate)) {
                const formattedRange = formatWeekRange(prevWeekDate);
                alert(`‚ö†Ô∏è La semana "${formattedRange}" ya existe.\n\nNo se pueden crear semanas duplicadas.`);
                return;
            }

            const newWeek = {
                id: weekCounter++,
                startDate: prevWeekDate,
                valor: '',
                actions: [createNewAction()]
            };

            weeks.push(newWeek);
            currentWeekId = newWeek.id;
            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        function deleteWeek() {
            if (weeks.length <= 1) {
                alert('No puedes eliminar la √∫ltima semana');
                return;
            }

            if (confirm('¬øEst√°s seguro de que quieres eliminar esta semana?')) {
                weeks = weeks.filter(w => w.id !== currentWeekId);
                currentWeekId = weeks[0].id;
                renderWeekSelector();
                loadCurrentWeek();
                autoSave();
            }
        }

        function changeWeek() {
            const selector = document.getElementById('week-selector');
            currentWeekId = selector.value; // Removed parseInt for UUID support
            loadCurrentWeek();
            autoSave();
        }

        function renderWeekSelector() {
            const selector = document.getElementById('week-selector');
            // Ordenar semanas por fecha de inicio (m√°s reciente primero)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            selector.innerHTML = sortedWeeks.map(week =>
                `<option value="${week.id}" ${week.id === currentWeekId ? 'selected' : ''}>
                    ${formatWeekRange(week.startDate)}
                </option>`
            ).join('');
        }

        function loadCurrentWeek() {
            const week = getCurrentWeek();
            if (week) {
                document.getElementById('valor').value = week.valor || '';
                renderActions();
            }
        }

        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = element.scrollHeight + 'px';
        }

        function renderActions() {
            const week = getCurrentWeek();
            if (!week) return;

            const container = document.getElementById('actions-container');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            container.innerHTML = week.actions.map(action => `
                <div class="action-card">
                    <div class="action-header">
                        <input type="text"
                               class="action-name"
                               value="${action.name}"
                               onchange="updateActionName('${action.id}', this.value)">
                        ${week.actions.length > 1 ? `
                            <button class="delete-btn" onclick="removeAction('${action.id}')">üóëÔ∏è Eliminar</button>
                        ` : ''}
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Evaluaci√≥n</th>
                                    ${days.map(day => `<th>${day}</th>`).join('')}
                                    <th class="comentarios-col">Comentarios (barreras)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Placer (0-10)</td>
                                    ${days.map(day => `
                                        <td>
                                            <input type="number"
                                                   min="0"
                                                   max="10"
                                                   aria-label="Placer ${day}"
                                                   value="${action.placer[day]}"
                                                   onchange="updateValue('${action.id}', 'placer', '${day}', this.value)">
                                        </td>
                                    `).join('')}
                                    <td class="comentarios-col" rowspan="2">
                                        <textarea class="comentarios"
                                                  onchange="updateComentarios('${action.id}', this.value)"
                                                  oninput="autoResizeTextarea(this)"
                                                  placeholder="Escribe aqu√≠ las barreras...">${action.comentarios}</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Sensaci√≥n de logro (0-10)</td>
                                    ${days.map(day => `
                                        <td>
                                            <input type="number"
                                                   min="0"
                                                   max="10"
                                                   aria-label="Logro ${day}"
                                                   value="${action.logro[day]}"
                                                   onchange="updateValue('${action.id}', 'logro', '${day}', this.value)">
                                        </td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Comentarios para m√≥vil (debajo de la tabla) -->
                    <div class="comentarios-mobile">
                        <label>Comentarios (barreras)</label>
                        <textarea onchange="updateComentarios('${action.id}', this.value)"
                                  oninput="autoResizeTextarea(this)"
                                  placeholder="Escribe aqu√≠ las barreras...">${action.comentarios}</textarea>
                    </div>
                </div>
            `).join('');

            // Aplicar auto-resize a todos los textareas despu√©s de renderizar
            setTimeout(() => {
                document.querySelectorAll('.comentarios, .comentarios-mobile textarea').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 0);
        }

        function updateActionName(id, name) {
            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action.name = name;
                    autoSave();
                }
            }
        }

        function updateValue(id, type, day, value) {
            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action[type][day] = value;
                    autoSave();
                }
            }
        }

        function updateComentarios(id, value) {
            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action.comentarios = value;
                    autoSave();
                }
            }
        }

        function updateValor() {
            const week = getCurrentWeek();
            if (week) {
                week.valor = document.getElementById('valor').value;
                autoSave();
            }
        }

        function autoSave() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId,
                weekCounter: weekCounter,
                actionCounter: actionCounter
            };
            localStorage.setItem('activacionConductual', JSON.stringify(data));
        }

        function exportBackup() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId,
                weekCounter: weekCounter,
                actionCounter: actionCounter,
                fecha: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activacion-conductual-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Backup exportado correctamente a tu carpeta de Descargas');
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // VALIDACI√ìN B√ÅSICA
                        if (!data || (Array.isArray(data.weeks) === false && !data.actions)) {
                            throw new Error("Estructura de archivo inv√°lida");
                        }

                        // L√≥gica de migraci√≥n existente...
                        if (data.actions && !data.weeks) {
                            // ... (tu c√≥digo legacy existente)
                            weeks = [{
                                id: 1,
                                startDate: getMonday(new Date()),
                                valor: data.valor || '',
                                actions: data.actions || []
                            }];
                            currentWeekId = 1;
                        } else {
                            weeks = data.weeks || [];
                            // Asegurar que si ven√≠an IDs num√©ricos antiguos, todo funcione
                            currentWeekId = data.currentWeekId || (weeks.length > 0 ? weeks[0].id : null);
                        }

                        renderWeekSelector();
                        loadCurrentWeek();
                        autoSave();
                        alert('‚úÖ Backup importado correctamente');
                    } catch (error) {
                        console.error(error);
                        alert('‚ùå Error: El archivo est√° da√±ado o no tiene el formato correcto.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function printAllWeeks() {
            const printContainer = document.getElementById('print-container');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            // Ordenar semanas por fecha (m√°s antigua primero para el reporte)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            // Generar HTML para todas las semanas
            const allWeeksHTML = sortedWeeks.map(week => {
                const actionsHTML = week.actions.map(action => `
                    <div class="action-card">
                        <div class="action-header">
                            <div class="action-name">${action.name}</div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Evaluaci√≥n</th>
                                        ${days.map(day => `<th>${day}</th>`).join('')}
                                        <th>Comentarios (barreras)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="label-cell">Placer (0-10)</td>
                                        ${days.map(day => `
                                            <td>${action.placer[day] || ''}</td>
                                        `).join('')}
                                        <td rowspan="2">
                                            <textarea class="comentarios" readonly>${action.comentarios}</textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Sensaci√≥n de logro (0-10)</td>
                                        ${days.map(day => `
                                            <td>${action.logro[day] || ''}</td>
                                        `).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="week-section">
                        <h1>Autorregistro de Activaci√≥n Conductual en base a valores</h1>
                        <div class="week-title">${formatWeekRange(week.startDate)}</div>

                        <div class="valor-section">
                            <label>Valor:</label>
                            <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 15px;">
                                ${week.valor || '(Sin especificar)'}
                            </div>
                        </div>

                        <p class="intro-text">Esta semana programo las siguientes acciones:</p>

                        ${actionsHTML}

                        <p class="footer-note">
                            * Eval√∫a cada d√≠a del 0 al 10 el placer experimentado y la sensaci√≥n de logro al realizar cada acci√≥n
                        </p>
                    </div>
                `;
            }).join('');

            printContainer.innerHTML = allWeeksHTML;

            // Imprimir
            window.print();
        }

        // Auto-guardar al cambiar el valor
        document.getElementById('valor').addEventListener('input', updateValor);

        function showStats() {
            const modal = document.getElementById('stats-modal');
            const container = document.getElementById('chart-container');

            // 1. Preparar datos
            // Ordenamos cronol√≥gicamente (antiguas primero)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            const dataPoints = sortedWeeks.map(week => {
                let totalPlacer = 0, countPlacer = 0;
                let totalLogro = 0, countLogro = 0;

                week.actions.forEach(action => {
                    Object.values(action.placer).forEach(v => {
                        if (v !== '') { totalPlacer += parseInt(v); countPlacer++; }
                    });
                    Object.values(action.logro).forEach(v => {
                        if (v !== '') { totalLogro += parseInt(v); countLogro++; }
                    });
                });

                return {
                    date: formatWeekRange(week.startDate).split(' ')[2], // Solo la fecha de inicio
                    placer: countPlacer ? (totalPlacer / countPlacer).toFixed(1) : 0,
                    logro: countLogro ? (totalLogro / countLogro).toFixed(1) : 0
                };
            });

            if (dataPoints.length === 0) {
                alert("No hay datos suficientes para generar estad√≠sticas.");
                return;
            }

            // 2. Generar SVG manualmente
            const width = 100;  // Unidades SVG (porcentajes)
            const height = 100;
            const padding = 10;
            const graphHeight = height - (padding * 2);
            const stepX = (width - (padding * 2)) / (dataPoints.length > 1 ? dataPoints.length - 1 : 1);

            // Funci√≥n para mapear valor (0-10) a coordenada Y (invertida porque SVG 0 es arriba)
            const getY = (val) => height - padding - ((val / 10) * graphHeight);

            // Construir puntos del pol√≠gono
            let pointsPlacer = "";
            let pointsLogro = "";
            let circlesHtml = "";

            dataPoints.forEach((pt, i) => {
                const x = padding + (i * stepX);
                const yP = getY(pt.placer);
                const yL = getY(pt.logro);

                pointsPlacer += `${x},${yP} `;
                pointsLogro += `${x},${yL} `;

                // C√≠rculos para los puntos (tooltip title nativo)
                circlesHtml += `<circle cx="${x}" cy="${yP}" r="2" fill="#667eea"><title>Semana ${pt.date}: Placer ${pt.placer}</title></circle>`;
                circlesHtml += `<circle cx="${x}" cy="${yL}" r="2" fill="#10b981"><title>Semana ${pt.date}: Logro ${pt.logro}</title></circle>`;
            });

            const svgContent = `
                <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 100%; overflow: visible;">
                    <!-- L√≠neas gu√≠a fondo -->
                    <line x1="${padding}" y1="${getY(0)}" x2="${width - padding}" y2="${getY(0)}" stroke="#eee" stroke-width="0.5" />
                    <line x1="${padding}" y1="${getY(5)}" x2="${width - padding}" y2="${getY(5)}" stroke="#eee" stroke-width="0.5" />
                    <line x1="${padding}" y1="${getY(10)}" x2="${width - padding}" y2="${getY(10)}" stroke="#eee" stroke-width="0.5" />

                    <!-- Gr√°ficos -->
                    <polyline points="${pointsPlacer}" fill="none" stroke="#667eea" stroke-width="1.5" />
                    <polyline points="${pointsLogro}" fill="none" stroke="#10b981" stroke-width="1.5" />

                    <!-- Puntos interactivos -->
                    ${circlesHtml}

                    <!-- Textos Ejes (Simple) -->
                    <text x="0" y="${getY(10)}" font-size="3" fill="#999">10</text>
                    <text x="0" y="${getY(5)}" font-size="3" fill="#999">5</text>
                    <text x="0" y="${getY(0)}" font-size="3" fill="#999">0</text>
                </svg>
            `;

            container.innerHTML = svgContent;
            modal.showModal();
        }

        // Inicializar la aplicaci√≥n
        initApp();

        // Manejo de instalaci√≥n PWA
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que Chrome muestre su propio banner
            e.preventDefault();
            // Guardar el evento para usarlo despu√©s
            deferredPrompt = e;
            // Mostrar nuestro banner personalizado
            installPrompt.classList.add('show');
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            // Mostrar el prompt de instalaci√≥n
            deferredPrompt.prompt();
            // Esperar la respuesta del usuario
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Usuario ${outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
            // Limpiar el prompt
            deferredPrompt = null;
            // Ocultar el banner
            installPrompt.classList.remove('show');
        });

        // Detectar si la app ya est√° instalada
        window.addEventListener('appinstalled', () => {
            console.log('PWA instalada exitosamente');
            installPrompt.classList.remove('show');
            deferredPrompt = null;
        });

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/behavioral-activation/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registrado con √©xito:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>

</html>