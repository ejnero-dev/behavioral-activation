<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorregistro de Activaci√≥n Conductual</title>

    <!-- PWA Meta Tags -->
    <meta name="description"
        content="Autorregistro de Activaci√≥n Conductual en base a valores - Herramienta para terapia psicol√≥gica">
    <meta name="author" content="Emilio Neva">
    <meta name="theme-color" content="#7C9885">
    <meta name="color-scheme" content="light">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ActConductual">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons para iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <style>
        /* ========================================
           THERAPEUTIC GARDEN DESIGN SYSTEM
           Calming ¬∑ Professional ¬∑ Distinctive
           ======================================== */

        :root {
            /* Color Palette - Therapeutic Garden */
            --sage-primary: #7C9885;
            --sage-deep: #5A8F69;
            --sky-blue: #8BA3B8;
            --warm-beige: #F5F1E8;
            --beige-dark: #E8E0D5;
            --terracotta: #C67B5C;
            --terracotta-light: #D4967A;

            /* Accent Colors for Action Cards */
            --accent-sage: #7C9885;
            --accent-teal: #6B9B9E;
            --accent-amber: #D4A574;
            --accent-lavender: #9B8FB8;
            --accent-coral: #D4937A;

            /* Neutrals */
            --text-dark: #2D3436;
            --text-medium: #5C6B73;
            --text-light: #9AABB8;
            --bg-white: #FFFFFF;
            --bg-light: #FAFAF9;
            --border-subtle: #E5E7EB;
            --border-medium: #D1D5DB;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(45, 52, 54, 0.08);
            --shadow-md: 0 4px 12px rgba(45, 52, 54, 0.1);
            --shadow-lg: 0 8px 24px rgba(45, 52, 54, 0.12);
            --shadow-focus: 0 0 0 3px rgba(124, 152, 133, 0.15);

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;

            /* Spacing Scale */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 20px;
            --space-lg: 32px;
            --space-xl: 48px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(165deg, var(--warm-beige) 0%, #EAE4D8 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--space-xl);
            position: relative;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: var(--sage-deep);
            text-align: center;
            margin-bottom: var(--space-lg);
            font-size: clamp(20px, 4vw, 28px);
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }

        /* Week Navigation */
        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: linear-gradient(to bottom, var(--warm-beige), var(--beige-dark));
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            gap: var(--space-sm);
            box-shadow: var(--shadow-sm);
        }

        .week-selector {
            flex: 1;
            min-width: 220px;
        }

        .week-selector select {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 500;
            background: var(--bg-white);
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .week-selector select:hover {
            border-color: var(--sage-primary);
        }

        .week-selector select:focus {
            outline: none;
            border-color: var(--sage-primary);
            box-shadow: var(--shadow-focus);
        }

        .week-buttons {
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
        }

        /* Unified Button System */
        .week-btn {
            background: var(--sage-primary);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .week-btn:hover {
            background: var(--sage-deep);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .week-btn:active {
            transform: translateY(0);
        }

        .week-btn.danger {
            background: var(--terracotta);
        }

        .week-btn.danger:hover {
            background: #B56A4F;
        }

        .week-btn:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        /* Valor Section */
        .valor-section {
            margin-bottom: var(--space-lg);
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: var(--space-xs);
            font-size: 15px;
            letter-spacing: -0.01em;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: all var(--transition-base);
            background-color: var(--bg-white) !important;
            color: var(--text-dark) !important;
            box-shadow: var(--shadow-sm);
        }

        input[type="text"]:hover,
        textarea:hover {
            border-color: var(--sage-primary);
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--sage-primary);
            box-shadow: var(--shadow-focus);
            background: var(--bg-white) !important;
        }

        .intro-text {
            color: var(--text-medium);
            margin-bottom: var(--space-md);
            font-size: 15px;
            font-weight: 500;
        }

        /* Action Cards with Rotating Border Colors */
        .action-card {
            border: 2px solid var(--border-subtle);
            border-left: 5px solid var(--accent-sage);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            background: var(--bg-white);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Rotating colors for action cards */
        .action-card:nth-child(5n+1) {
            border-left-color: var(--accent-sage);
        }

        .action-card:nth-child(5n+2) {
            border-left-color: var(--accent-teal);
        }

        .action-card:nth-child(5n+3) {
            border-left-color: var(--accent-amber);
        }

        .action-card:nth-child(5n+4) {
            border-left-color: var(--accent-lavender);
        }

        .action-card:nth-child(5n+5) {
            border-left-color: var(--accent-coral);
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            gap: var(--space-sm);
        }

        .action-name {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            background-color: var(--bg-white) !important;
            color: var(--text-dark) !important;
            transition: all var(--transition-base);
        }

        .action-name:focus {
            outline: none;
            border-color: var(--sage-primary);
            box-shadow: var(--shadow-focus);
        }

        .delete-btn {
            background: var(--terracotta);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .delete-btn:hover {
            background: #B56A4F;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        /* Table Styles - Most Used Element */
        .table-container {
            overflow-x: auto;
            margin-top: var(--space-md);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-white);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        th {
            background: linear-gradient(135deg, var(--sage-primary), var(--sage-deep));
            color: white;
            padding: 14px 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: none;
            position: relative;
        }

        th:first-child {
            text-align: left;
            padding-left: 16px;
        }

        tbody tr {
            transition: background var(--transition-base);
        }

        tbody tr:hover {
            background: linear-gradient(to right, var(--warm-beige), transparent);
        }

        tbody tr:nth-child(odd) {
            background: var(--bg-light);
        }

        tbody tr:nth-child(even) {
            background: var(--bg-white);
        }

        tbody tr:nth-child(odd):hover {
            background: linear-gradient(to right, var(--beige-dark), var(--bg-light));
        }

        td {
            border: 1px solid var(--border-subtle);
            border-left: none;
            border-right: none;
            padding: 10px;
            text-align: center;
        }

        td:first-child {
            border-left: 1px solid var(--border-subtle);
        }

        td:last-child {
            border-right: 1px solid var(--border-subtle);
        }

        td.label-cell {
            background: linear-gradient(to right, var(--warm-beige), transparent);
            font-weight: 600;
            text-align: left;
            padding-left: 16px;
            color: var(--text-dark);
        }

        /* Number Inputs in Table */
        input[type="number"] {
            width: 100%;
            padding: 10px 6px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            background-color: var(--bg-white) !important;
            color: var(--text-dark) !important;
            -webkit-appearance: none;
            appearance: none;
            min-height: 40px;
            box-sizing: border-box;
            transition: all var(--transition-base);
        }

        input[type="number"]:hover {
            border-color: var(--sage-primary);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--sage-primary);
            background-color: var(--bg-white) !important;
            box-shadow: var(--shadow-focus);
            transform: scale(1.02);
        }

        /* Textarea in table */
        textarea.comentarios {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-sm);
            resize: vertical;
            font-size: 14px;
            overflow-y: hidden;
            font-family: inherit;
            transition: all var(--transition-base);
            background: var(--bg-white) !important;
            color: var(--text-dark) !important;
        }

        textarea.comentarios:hover {
            border-color: var(--sage-primary);
        }

        textarea.comentarios:focus {
            outline: none;
            border-color: var(--sage-primary);
            box-shadow: var(--shadow-focus);
        }

        /* Add Action Button */
        .add-btn {
            background: var(--sage-primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all var(--transition-base);
            margin-top: var(--space-md);
            box-shadow: var(--shadow-md);
        }

        .add-btn:hover {
            background: var(--sage-deep);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        /* Auto-save Info */
        .autosave-info {
            text-align: center;
            margin-top: var(--space-md);
            font-size: 14px;
            color: var(--sage-deep);
            font-weight: 600;
        }

        /* Footer Note */
        .footer-note {
            margin-top: var(--space-md);
            padding: var(--space-sm);
            font-size: 13px;
            color: var(--text-medium);
            font-style: italic;
            background: var(--warm-beige);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--sky-blue);
        }

        /* Export Section */
        .export-section {
            margin-top: var(--space-lg);
            padding-top: var(--space-md);
            border-top: 2px solid var(--border-subtle);
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--sage-deep);
            color: white;
            border: none;
            padding: 11px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .export-btn:hover {
            background: #4A7756;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        /* Install Prompt - Subtle and Calm */
        .install-prompt {
            background: linear-gradient(135deg, var(--sage-primary), var(--sage-deep));
            color: white;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            text-align: center;
            display: none;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-prompt.show {
            display: block;
        }

        .install-btn {
            background: white;
            color: var(--sage-deep);
            border: none;
            padding: 11px 24px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: var(--space-sm);
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .install-btn:active {
            transform: translateY(0);
        }

        /* Mobile Comments Section */
        .comentarios-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 18px;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 4px 2px;
            }

            /* Inputs m√°s grandes en m√≥vil */
            input[type="number"] {
                padding: 10px 2px;
                font-size: 18px;
                min-height: 40px;
            }

            /* Ocultar columna de comentarios en m√≥vil */
            th.comentarios-col,
            td.comentarios-col {
                display: none;
            }

            /* Mostrar comentarios debajo de la tabla */
            .comentarios-mobile {
                display: block;
                margin-top: 15px;
            }

            .comentarios-mobile label {
                display: block;
                font-weight: 600;
                color: #555;
                margin-bottom: 8px;
                font-size: 14px;
            }

            .comentarios-mobile textarea {
                width: 100%;
                min-height: 100px;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background-color: white !important;
                color: #333 !important;
                font-family: inherit;
            }
        }

        /* Print Styles Elements */
        .week-section {
            margin-bottom: var(--space-xl);
            page-break-after: always;
        }

        .week-section:last-child {
            page-break-after: auto;
        }

        .week-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--sage-deep);
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 3px solid var(--sage-primary);
        }

        #print-container {
            display: none;
        }

        /* ========================================
           B2B PROFESSIONAL SECTION (NEW)
           Inviting therapists to professional version
           ======================================== */

        .professional-cta {
            margin-top: var(--space-xl);
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
            background: linear-gradient(to bottom right, var(--warm-beige), var(--beige-dark));
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-subtle);
            border-top: 4px solid var(--sky-blue);
            box-shadow: var(--shadow-md);
        }

        .professional-cta-content {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            flex-wrap: wrap;
        }

        .professional-cta-icon {
            flex-shrink: 0;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .professional-cta-icon svg {
            width: 100%;
            height: 100%;
            opacity: 0.9;
        }

        .professional-cta-text {
            flex: 1;
            min-width: 280px;
        }

        .professional-cta-text h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: var(--space-sm);
            letter-spacing: -0.01em;
        }

        .professional-cta-text p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-medium);
            margin: 0;
        }

        .professional-cta-button {
            flex-shrink: 0;
            background: var(--sage-primary);
            color: white;
            text-decoration: none;
            padding: 13px 26px;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
            display: inline-block;
        }

        .professional-cta-button:hover {
            background: var(--sage-deep);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .professional-cta-button:active {
            transform: translateY(0);
        }

        /* ========================================
           FOOTER STYLES
           ======================================== */

        .app-footer {
            margin-top: var(--space-xl);
            padding-top: var(--space-lg);
            border-top: 2px solid var(--border-subtle);
            text-align: center;
        }

        .privacy-notice {
            background: linear-gradient(to right, #F0FDF4, #ECFDF5);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--sage-deep);
            margin-bottom: var(--space-md);
            font-size: 14px;
            color: var(--sage-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            font-weight: 500;
        }

        .privacy-notice .lock-icon {
            font-size: 18px;
        }

        .developer-info {
            margin-bottom: var(--space-md);
        }

        .developer-info .name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--space-sm);
        }

        .contact-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-md);
            margin: var(--space-md) 0;
            flex-wrap: wrap;
        }

        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--sage-primary);
            text-decoration: none;
            font-size: 14px;
            transition: all var(--transition-base);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
        }

        .contact-link:hover {
            background: var(--warm-beige);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .contact-link .icon {
            font-size: 18px;
        }

        .footer-meta {
            font-size: 12px;
            color: var(--text-light);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-subtle);
        }

        .footer-meta a {
            color: var(--sage-primary);
            text-decoration: none;
        }

        .footer-meta a:hover {
            text-decoration: underline;
        }

        /* Responsive - B2B Section */
        @media (max-width: 768px) {
            .professional-cta-content {
                flex-direction: column;
                text-align: center;
            }

            .professional-cta-icon {
                width: 56px;
                height: 56px;
            }

            .professional-cta-text h3 {
                font-size: 18px;
            }

            .professional-cta-text p {
                font-size: 14px;
            }

            .professional-cta-button {
                width: 100%;
                text-align: center;
            }

            .contact-links {
                flex-direction: column;
                gap: var(--space-xs);
            }

            .app-footer {
                margin-top: var(--space-lg);
                padding-top: var(--space-md);
            }

            .privacy-notice {
                font-size: 13px;
                padding: var(--space-sm);
            }
        }

        /* ========================================
           OFFLINE INDICATOR
           ======================================== */

        .offline-mode::before {
            content: 'üì¥ Sin conexi√≥n - Los cambios se guardan localmente';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--terracotta);
            color: white;
            text-align: center;
            padding: var(--space-xs);
            font-size: 13px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: var(--shadow-md);
        }

        .offline-mode .container {
            margin-top: 40px;
        }

        /* ========================================
           PRINT STYLES
           ======================================== */

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                display: none;
            }

            #print-container {
                display: block !important;
                max-width: 100%;
                padding: 20px;
            }

            .add-btn,
            .delete-btn,
            .export-section,
            .week-navigation,
            .autosave-info,
            .app-footer,
            .install-prompt,
            .professional-cta {
                display: none !important;
            }

            textarea.comentarios {
                border: none;
                overflow: visible;
                height: auto;
                resize: none;
                page-break-inside: avoid;
                white-space: pre-wrap;
            }

            .action-card {
                page-break-inside: avoid;
                border-left-color: var(--sage-primary) !important;
            }

            table {
                page-break-inside: auto;
            }

            th {
                background: var(--sage-primary) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .week-section {
                page-break-after: always;
            }

            .week-section:last-child {
                page-break-after: auto;
            }

            .week-title {
                color: var(--sage-deep) !important;
                border-bottom-color: var(--sage-primary) !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Autorregistro de Activaci√≥n Conductual en base a valores</h1>

        <!-- Banner de instalaci√≥n -->
        <div id="install-prompt" class="install-prompt">
            <p style="margin: 0 0 5px 0; font-weight: 600;">üì± Instala esta app en tu m√≥vil</p>
            <p style="margin: 0 0 10px 0; font-size: 13px;">Accede m√°s r√°pido y √∫sala sin conexi√≥n</p>
            <button id="install-button" class="install-btn">‚¨áÔ∏è Instalar App</button>
        </div>

        <div class="week-navigation">
            <div class="week-selector">
                <select id="week-selector" onchange="changeWeek()">
                    <!-- Las opciones se generar√°n din√°micamente -->
                </select>
            </div>
            <div class="week-buttons">
                <button class="week-btn" onclick="addNewWeek()">‚ûï Semana Siguiente</button>
                <button class="week-btn" onclick="addPreviousWeek()">‚¨ÖÔ∏è Semana Anterior</button>
                <button class="week-btn danger" onclick="deleteWeek()">üóëÔ∏è Eliminar Semana</button>
            </div>
        </div>

        <div class="valor-section">
            <label>Valor:</label>
            <input type="text" id="valor" placeholder="Escribe el valor que guiar√° tus acciones esta semana">
        </div>

        <p class="intro-text">Esta semana programo las siguientes acciones:</p>

        <div id="actions-container"></div>

        <button class="add-btn" onclick="addAction()">
            <span>‚ûï</span> Agregar Acci√≥n
        </button>

        <div class="export-section">
            <button class="export-btn" onclick="exportBackup()">üì• Exportar Backup</button>
            <button class="export-btn" onclick="importBackup()">üì§ Importar Backup</button>
            <button class="export-btn" onclick="printAllWeeks()">üñ®Ô∏è Imprimir Todas las Semanas</button>
            <button class="export-btn" onclick="showStats()">üìä Ver Progreso</button>
        </div>

        <p class="autosave-info">
            ‚úì Tus cambios se guardan autom√°ticamente
        </p>

        <p class="footer-note">
            * Eval√∫a cada d√≠a del 0 al 10 el placer experimentado y la sensaci√≥n de logro al realizar cada acci√≥n
        </p>

        <!-- B2B Professional Section -->
        <section class="professional-cta">
            <div class="professional-cta-content">
                <div class="professional-cta-icon">
                    <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Clipboard icon with checkmarks -->
                        <rect x="16" y="8" width="32" height="48" rx="2" stroke="#7C9885" stroke-width="2.5"
                            fill="#F5F1E8" />
                        <rect x="24" y="4" width="16" height="8" rx="2" fill="#7C9885" />
                        <!-- Checkmarks -->
                        <path d="M22 20 L26 24 L32 18" stroke="#5A8F69" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M22 30 L26 34 L32 28" stroke="#5A8F69" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M22 40 L26 44 L32 38" stroke="#8BA3B8" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <!-- Lines -->
                        <line x1="36" y1="22" x2="44" y2="22" stroke="#9AABB8" stroke-width="2" stroke-linecap="round" />
                        <line x1="36" y1="32" x2="44" y2="32" stroke="#9AABB8" stroke-width="2" stroke-linecap="round" />
                        <line x1="36" y1="42" x2="42" y2="42" stroke="#9AABB8" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="professional-cta-text">
                    <h3>¬øEres profesional de salud mental?</h3>
                    <p>Si usas Activaci√≥n Conductual con tus pacientes, estoy desarrollando una versi√≥n con panel de
                        seguimiento para terapeutas. Me encantar√≠a conocer tu opini√≥n.</p>
                </div>
                <a href="mailto:ejnero.dev@gmail.com?subject=Inter√©s en versi√≥n profesional de Activaci√≥n Conductual"
                    class="professional-cta-button">
                    Quiero participar
                </a>
            </div>
        </section>

        <!-- Footer Profesional -->
        <footer class="app-footer">
            <div class="privacy-notice">
                <span class="lock-icon">üîí</span>
                <span>Tus datos nunca salen de tu dispositivo - Privacidad garantizada</span>
            </div>

            <div class="developer-info">
                <div class="name">Desarrollado por Emilio Neva</div>
                <div class="contact-links">
                    <a href="mailto:ejnero.dev@gmail.com" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üìß</span>
                        <span>ejnero.dev@gmail.com</span>
                    </a>
                    <a href="https://www.linkedin.com/in/emilioneva/" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üíº</span>
                        <span>LinkedIn</span>
                    </a>
                    <a href="https://github.com/ejnero-dev/behavioral-activation" class="contact-link" target="_blank"
                        rel="noopener noreferrer">
                        <span class="icon">üíª</span>
                        <span>GitHub</span>
                    </a>
                </div>
            </div>

            <div class="footer-meta">
                ¬© 2025 Emilio Neva - <a href="https://github.com/ejnero-dev/behavioral-activation/blob/main/LICENSE"
                    target="_blank" rel="noopener noreferrer">Licencia MIT</a> - v1.0
            </div>
        </footer>
    </div>

    <!-- Contenedor para impresi√≥n de todas las semanas -->
    <div id="print-container"></div>

    <!-- Modal de Estad√≠sticas -->
    <dialog id="stats-modal"
        style="border: none; border-radius: 12px; padding: 20px; max-width: 600px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #333;">Mi Progreso</h2>
            <button onclick="document.getElementById('stats-modal').close()"
                style="border: none; background: none; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Promedio semanal de Placer y Logro (0-10)</p>

        <!-- Contenedor del gr√°fico SVG -->
        <div id="chart-container"
            style="width: 100%; height: 250px; background: #f9f9f9; border-radius: 8px; position: relative; border: 1px solid #eee;">
            <!-- El SVG se inyectar√° aqu√≠ -->
        </div>

        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 12px;">
            <div style="display: flex; align-items: center; gap: 5px;"><span
                    style="width: 10px; height: 10px; background: #667eea; border-radius: 50%;"></span> Placer</div>
            <div style="display: flex; align-items: center; gap: 5px;"><span
                    style="width: 10px; height: 10px; background: #10b981; border-radius: 50%;"></span> Logro</div>
        </div>
    </dialog>

    <script>
        let weeks = [];
        let currentWeekId = null;
        let weekCounter = 1;
        let actionCounter = 1;

        function initApp() {
            // Cargar datos guardados si existen
            const savedData = localStorage.getItem('activacionConductual');
            if (savedData) {
                const data = JSON.parse(savedData);

                // Migrar datos antiguos al nuevo formato si es necesario
                if (data.actions && !data.weeks) {
                    // Formato antiguo, migrar
                    weeks = [{
                        id: 1,
                        startDate: getMonday(new Date()),
                        valor: data.valor || '',
                        actions: data.actions || []
                    }];
                    currentWeekId = 1;
                    weekCounter = 2;
                    actionCounter = data.actionCounter || 1;
                } else {
                    // Formato nuevo
                    weeks = data.weeks || [];
                    currentWeekId = data.currentWeekId || null;
                    weekCounter = data.weekCounter || 1;
                    actionCounter = data.actionCounter || 1;
                }
            }

            // Si no hay semanas, crear una por defecto
            if (weeks.length === 0) {
                weeks.push(createNewWeek());
                currentWeekId = weeks[0].id;
            }

            // Si currentWeekId no est√° establecido o no es v√°lido, usar la primera semana
            if (!currentWeekId || !weeks.find(w => w.id === currentWeekId)) {
                currentWeekId = weeks[0].id;
            }

            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        // Formato fecha local YYYY-MM-DD (evita problemas de timezone con toISOString)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return formatLocalDate(d);
        }

        function formatWeekRange(startDate) {
            const start = new Date(startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);

            const formatDate = (d) => {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            };

            return `Semana del ${formatDate(start)} al ${formatDate(end)}`;
        }

        function weekExists(startDate) {
            return weeks.some(w => w.startDate === startDate);
        }

        function getNextWeekDate() {
            if (weeks.length === 0) {
                return getMonday(new Date());
            }
            // Encontrar la semana m√°s reciente
            const mostRecentWeek = weeks.reduce((latest, week) => {
                return new Date(week.startDate) > new Date(latest.startDate) ? week : latest;
            });
            // Calcular siguiente lunes (+ 7 d√≠as)
            const nextDate = new Date(mostRecentWeek.startDate);
            nextDate.setDate(nextDate.getDate() + 7);
            return formatLocalDate(nextDate);
        }

        function getPreviousWeekDate() {
            if (weeks.length === 0) {
                // Si no hay semanas, crear una semana atr√°s desde hoy
                const prevDate = new Date();
                const day = prevDate.getDay();
                const diff = prevDate.getDate() - day + (day === 0 ? -6 : 1) - 7;
                prevDate.setDate(diff);
                return formatLocalDate(prevDate);
            }
            // Encontrar la semana m√°s antigua
            const oldestWeek = weeks.reduce((oldest, week) => {
                return new Date(week.startDate) < new Date(oldest.startDate) ? week : oldest;
            });
            // Calcular lunes anterior (- 7 d√≠as)
            const prevDate = new Date(oldestWeek.startDate);
            prevDate.setDate(prevDate.getDate() - 7);
            return formatLocalDate(prevDate);
        }

        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback para navegadores muy antiguos
            return Date.now().toString(36) + Math.random().toString(36).slice(2);
        }

        // Sanitizaci√≥n de HTML para prevenir XSS
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function createNewWeek() {
            return {
                id: generateUUID(),
                startDate: getMonday(new Date()),
                valor: '',
                actions: [createNewAction()]
            };
        }

        function createNewAction() {
            // Calculamos el n√∫mero de acci√≥n solo para el nombre visible, no para el ID
            const currentActions = getCurrentWeek() ? getCurrentWeek().actions.length + 1 : 1;
            return {
                id: generateUUID(),
                name: `Acci√≥n ${currentActions}`,
                placer: { L: '', M: '', X: '', J: '', V: '', S: '', D: '' },
                logro: { L: '', M: '', X: '', J: '', V: '', S: '', D: '' },
                comentarios: ''
            };
        }

        function getCurrentWeek() {
            return weeks.find(w => w.id === currentWeekId);
        }

        function addAction() {
            const week = getCurrentWeek();
            if (week) {
                week.actions.push(createNewAction());
                renderActions();
                autoSave();
            }
        }

        function removeAction(id) {
            const week = getCurrentWeek();
            if (!week || week.actions.length <= 1) return;

            const actionExists = week.actions.some(a => a.id === id);
            if (!actionExists) {
                console.warn('removeAction: acci√≥n no encontrada');
                return;
            }

            week.actions = week.actions.filter(a => a.id !== id);
            renderActions();
            autoSave();
        }

        function addNewWeek() {
            const nextWeekDate = getNextWeekDate();

            // Validar que no exista esa semana
            if (weekExists(nextWeekDate)) {
                const formattedRange = formatWeekRange(nextWeekDate);
                alert(`‚ö†Ô∏è La semana "${formattedRange}" ya existe.\n\nNo se pueden crear semanas duplicadas.`);
                return;
            }

            const newWeek = {
                id: generateUUID(),
                startDate: nextWeekDate,
                valor: '',
                actions: [createNewAction()]
            };

            weeks.push(newWeek);
            currentWeekId = newWeek.id;
            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        function addPreviousWeek() {
            const prevWeekDate = getPreviousWeekDate();

            // Validar que no exista esa semana
            if (weekExists(prevWeekDate)) {
                const formattedRange = formatWeekRange(prevWeekDate);
                alert(`‚ö†Ô∏è La semana "${formattedRange}" ya existe.\n\nNo se pueden crear semanas duplicadas.`);
                return;
            }

            const newWeek = {
                id: generateUUID(),
                startDate: prevWeekDate,
                valor: '',
                actions: [createNewAction()]
            };

            weeks.push(newWeek);
            currentWeekId = newWeek.id;
            renderWeekSelector();
            loadCurrentWeek();
            autoSave();
        }

        function deleteWeek() {
            if (weeks.length <= 1) {
                alert('No puedes eliminar la √∫ltima semana');
                return;
            }

            if (confirm('¬øEst√°s seguro de que quieres eliminar esta semana?')) {
                const deletedId = currentWeekId;
                weeks = weeks.filter(w => w.id !== deletedId);

                // Seleccionar la semana m√°s reciente
                if (weeks.length > 0) {
                    const mostRecent = weeks.reduce((latest, week) =>
                        new Date(week.startDate) > new Date(latest.startDate) ? week : latest
                    );
                    currentWeekId = mostRecent.id;
                }

                renderWeekSelector();
                loadCurrentWeek();
                autoSave();
            }
        }

        function changeWeek() {
            const selector = document.getElementById('week-selector');
            currentWeekId = selector.value; // Removed parseInt for UUID support
            loadCurrentWeek();
            autoSave();
        }

        function renderWeekSelector() {
            const selector = document.getElementById('week-selector');
            // Ordenar semanas por fecha de inicio (m√°s reciente primero)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            selector.innerHTML = sortedWeeks.map(week =>
                `<option value="${week.id}" ${week.id === currentWeekId ? 'selected' : ''}>
                    ${formatWeekRange(week.startDate)}
                </option>`
            ).join('');
        }

        function loadCurrentWeek() {
            const week = getCurrentWeek();
            if (week) {
                document.getElementById('valor').value = week.valor || '';
                renderActions();
            }
        }

        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = element.scrollHeight + 'px';
        }

        function renderActions() {
            const week = getCurrentWeek();
            if (!week) return;

            const container = document.getElementById('actions-container');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            container.innerHTML = week.actions.map(action => `
                <div class="action-card">
                    <div class="action-header">
                        <input type="text"
                               class="action-name"
                               value="${escapeHtml(action.name)}"
                               onchange="updateActionName('${escapeHtml(action.id)}', this.value)">
                        ${week.actions.length > 1 ? `
                            <button class="delete-btn" onclick="removeAction('${escapeHtml(action.id)}')">üóëÔ∏è Eliminar</button>
                        ` : ''}
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Evaluaci√≥n</th>
                                    ${days.map(day => `<th>${day}</th>`).join('')}
                                    <th class="comentarios-col">Comentarios (barreras)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="label-cell">Placer (0-10)</td>
                                    ${days.map(day => `
                                        <td>
                                            <input type="number"
                                                   min="0"
                                                   max="10"
                                                   aria-label="Placer ${day}"
                                                   value="${escapeHtml(action.placer[day])}"
                                                   onchange="updateValue('${escapeHtml(action.id)}', 'placer', '${day}', this.value)">
                                        </td>
                                    `).join('')}
                                    <td class="comentarios-col" rowspan="2">
                                        <textarea class="comentarios"
                                                  data-action-id="${escapeHtml(action.id)}"
                                                  onchange="updateComentarios('${escapeHtml(action.id)}', this.value)"
                                                  oninput="autoResizeTextarea(this)"
                                                  placeholder="Escribe aqu√≠ las barreras...">${escapeHtml(action.comentarios)}</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-cell">Sensaci√≥n de logro (0-10)</td>
                                    ${days.map(day => `
                                        <td>
                                            <input type="number"
                                                   min="0"
                                                   max="10"
                                                   aria-label="Logro ${day}"
                                                   value="${escapeHtml(action.logro[day])}"
                                                   onchange="updateValue('${escapeHtml(action.id)}', 'logro', '${day}', this.value)">
                                        </td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Comentarios para m√≥vil (debajo de la tabla) -->
                    <div class="comentarios-mobile">
                        <label>Comentarios (barreras)</label>
                        <textarea data-action-id="${escapeHtml(action.id)}"
                                  onchange="updateComentarios('${escapeHtml(action.id)}', this.value)"
                                  oninput="autoResizeTextarea(this)"
                                  placeholder="Escribe aqu√≠ las barreras...">${escapeHtml(action.comentarios)}</textarea>
                    </div>
                </div>
            `).join('');

            // Aplicar auto-resize a todos los textareas despu√©s de renderizar
            setTimeout(() => {
                document.querySelectorAll('.comentarios, .comentarios-mobile textarea').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 0);
        }

        function updateActionName(id, name) {
            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action.name = name;
                    autoSave();
                }
            }
        }

        function updateValue(id, type, day, value) {
            const validDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            const validTypes = ['placer', 'logro'];

            // Validar d√≠a y tipo
            if (!validDays.includes(day) || !validTypes.includes(type)) {
                console.warn('updateValue: d√≠a o tipo inv√°lido');
                return;
            }

            // Validar valor (vac√≠o o n√∫mero 0-10)
            if (value !== '' && value !== null && value !== undefined) {
                const numValue = parseInt(value, 10);
                if (isNaN(numValue) || numValue < 0 || numValue > 10) {
                    console.warn('updateValue: valor fuera de rango 0-10');
                    return;
                }
                value = numValue;
            }

            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action[type][day] = value;
                    autoSave();
                }
            }
        }

        function updateComentarios(id, value) {
            const week = getCurrentWeek();
            if (week) {
                const action = week.actions.find(a => a.id === id);
                if (action) {
                    action.comentarios = value;
                    // Sincronizar ambos textareas (m√≥vil y desktop)
                    document.querySelectorAll(`textarea[data-action-id="${id}"]`).forEach(ta => {
                        if (ta.value !== value) {
                            ta.value = value;
                            autoResizeTextarea(ta);
                        }
                    });
                    autoSave();
                }
            }
        }

        function updateValor() {
            const week = getCurrentWeek();
            if (week) {
                week.valor = document.getElementById('valor').value;
                autoSave();
            }
        }

        function autoSave() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId,
                weekCounter: weekCounter,
                actionCounter: actionCounter
            };
            localStorage.setItem('activacionConductual', JSON.stringify(data));
        }

        function exportBackup() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId,
                weekCounter: weekCounter,
                actionCounter: actionCounter,
                fecha: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activacion-conductual-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Backup exportado correctamente a tu carpeta de Descargas');
        }

        // Validar estructura de una semana importada
        function validateWeekStructure(week) {
            const validDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            // Validar campos requeridos
            if (week.id === undefined || week.id === null) return false;
            if (!week.startDate) return false;
            if (!Array.isArray(week.actions)) return false;

            // Validar formato de fecha (YYYY-MM-DD)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(week.startDate)) return false;

            // Validar valor (string con l√≠mite)
            if (week.valor && (typeof week.valor !== 'string' || week.valor.length > 1000)) return false;

            // Validar acciones
            for (const action of week.actions) {
                if (action.id === undefined || action.id === null) return false;
                if (typeof action.name !== 'string' || action.name.length > 500) return false;
                if (!action.placer || typeof action.placer !== 'object') return false;
                if (!action.logro || typeof action.logro !== 'object') return false;
                if (action.comentarios && (typeof action.comentarios !== 'string' || action.comentarios.length > 5000)) return false;

                // Validar que solo existan d√≠as v√°lidos
                for (const day of Object.keys(action.placer)) {
                    if (!validDays.includes(day)) return false;
                }
                for (const day of Object.keys(action.logro)) {
                    if (!validDays.includes(day)) return false;
                }
            }

            return true;
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // VALIDACI√ìN B√ÅSICA
                        if (!data || (Array.isArray(data.weeks) === false && !data.actions)) {
                            throw new Error("Estructura de archivo inv√°lida");
                        }

                        // L√≥gica de migraci√≥n existente...
                        if (data.actions && !data.weeks) {
                            // Formato legacy (una sola semana)
                            const newWeekId = generateUUID();
                            weeks = [{
                                id: newWeekId,
                                startDate: getMonday(new Date()),
                                valor: data.valor || '',
                                actions: data.actions || []
                            }];
                            currentWeekId = newWeekId;
                        } else {
                            // Validar estructura de cada semana
                            for (const week of data.weeks) {
                                if (!validateWeekStructure(week)) {
                                    throw new Error("Estructura de semana inv√°lida");
                                }
                            }
                            weeks = data.weeks || [];
                            // Asegurar que si ven√≠an IDs num√©ricos antiguos, todo funcione
                            currentWeekId = data.currentWeekId || (weeks.length > 0 ? weeks[0].id : null);
                        }

                        renderWeekSelector();
                        loadCurrentWeek();
                        autoSave();
                        alert('‚úÖ Backup importado correctamente');
                    } catch (error) {
                        console.error(error);
                        alert('‚ùå Error: El archivo est√° da√±ado o no tiene el formato correcto.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function printAllWeeks() {
            const printContainer = document.getElementById('print-container');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            // Ordenar semanas por fecha (m√°s antigua primero para el reporte)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            // Generar HTML para todas las semanas
            const allWeeksHTML = sortedWeeks.map(week => {
                const actionsHTML = week.actions.map(action => `
                    <div class="action-card">
                        <div class="action-header">
                            <div class="action-name">${escapeHtml(action.name)}</div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Evaluaci√≥n</th>
                                        ${days.map(day => `<th>${day}</th>`).join('')}
                                        <th>Comentarios (barreras)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="label-cell">Placer (0-10)</td>
                                        ${days.map(day => `
                                            <td>${escapeHtml(action.placer[day]) || ''}</td>
                                        `).join('')}
                                        <td rowspan="2">
                                            <textarea class="comentarios" readonly>${escapeHtml(action.comentarios)}</textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Sensaci√≥n de logro (0-10)</td>
                                        ${days.map(day => `
                                            <td>${escapeHtml(action.logro[day]) || ''}</td>
                                        `).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="week-section">
                        <h1>Autorregistro de Activaci√≥n Conductual en base a valores</h1>
                        <div class="week-title">${formatWeekRange(week.startDate)}</div>

                        <div class="valor-section">
                            <label>Valor:</label>
                            <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 15px;">
                                ${escapeHtml(week.valor) || '(Sin especificar)'}
                            </div>
                        </div>

                        <p class="intro-text">Esta semana programo las siguientes acciones:</p>

                        ${actionsHTML}

                        <p class="footer-note">
                            * Eval√∫a cada d√≠a del 0 al 10 el placer experimentado y la sensaci√≥n de logro al realizar cada acci√≥n
                        </p>
                    </div>
                `;
            }).join('');

            printContainer.innerHTML = allWeeksHTML;

            // Imprimir
            window.print();
        }

        // Auto-guardar al cambiar el valor
        document.getElementById('valor').addEventListener('input', updateValor);

        function showStats() {
            const modal = document.getElementById('stats-modal');
            const container = document.getElementById('chart-container');

            // 1. Preparar datos
            // Ordenamos cronol√≥gicamente (antiguas primero)
            const sortedWeeks = [...weeks].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            const dataPoints = sortedWeeks.map(week => {
                let totalPlacer = 0, countPlacer = 0;
                let totalLogro = 0, countLogro = 0;

                week.actions.forEach(action => {
                    Object.values(action.placer).forEach(v => {
                        if (v !== '') { totalPlacer += parseInt(v); countPlacer++; }
                    });
                    Object.values(action.logro).forEach(v => {
                        if (v !== '') { totalLogro += parseInt(v); countLogro++; }
                    });
                });

                return {
                    date: formatWeekRange(week.startDate).split(' ')[2], // Solo la fecha de inicio
                    placer: countPlacer ? (totalPlacer / countPlacer).toFixed(1) : 0,
                    logro: countLogro ? (totalLogro / countLogro).toFixed(1) : 0
                };
            });

            if (dataPoints.length === 0) {
                alert("No hay datos suficientes para generar estad√≠sticas.");
                return;
            }

            // 2. Generar SVG manualmente
            const width = 100;  // Unidades SVG (porcentajes)
            const height = 100;
            const padding = 10;
            const graphHeight = height - (padding * 2);
            const stepX = (width - (padding * 2)) / (dataPoints.length > 1 ? dataPoints.length - 1 : 1);

            // Funci√≥n para mapear valor (0-10) a coordenada Y (invertida porque SVG 0 es arriba)
            const getY = (val) => height - padding - ((val / 10) * graphHeight);

            // Construir puntos del pol√≠gono
            let pointsPlacer = "";
            let pointsLogro = "";
            let circlesHtml = "";

            dataPoints.forEach((pt, i) => {
                const x = padding + (i * stepX);
                const yP = getY(pt.placer);
                const yL = getY(pt.logro);

                pointsPlacer += `${x},${yP} `;
                pointsLogro += `${x},${yL} `;

                // C√≠rculos para los puntos (tooltip title nativo)
                circlesHtml += `<circle cx="${x}" cy="${yP}" r="2" fill="#667eea"><title>Semana ${escapeHtml(pt.date)}: Placer ${escapeHtml(pt.placer)}</title></circle>`;
                circlesHtml += `<circle cx="${x}" cy="${yL}" r="2" fill="#10b981"><title>Semana ${escapeHtml(pt.date)}: Logro ${escapeHtml(pt.logro)}</title></circle>`;
            });

            const svgContent = `
                <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 100%; overflow: visible;">
                    <!-- L√≠neas gu√≠a fondo -->
                    <line x1="${padding}" y1="${getY(0)}" x2="${width - padding}" y2="${getY(0)}" stroke="#eee" stroke-width="0.5" />
                    <line x1="${padding}" y1="${getY(5)}" x2="${width - padding}" y2="${getY(5)}" stroke="#eee" stroke-width="0.5" />
                    <line x1="${padding}" y1="${getY(10)}" x2="${width - padding}" y2="${getY(10)}" stroke="#eee" stroke-width="0.5" />

                    <!-- Gr√°ficos -->
                    <polyline points="${pointsPlacer}" fill="none" stroke="#667eea" stroke-width="1.5" />
                    <polyline points="${pointsLogro}" fill="none" stroke="#10b981" stroke-width="1.5" />

                    <!-- Puntos interactivos -->
                    ${circlesHtml}

                    <!-- Textos Ejes (Simple) -->
                    <text x="0" y="${getY(10)}" font-size="3" fill="#999">10</text>
                    <text x="0" y="${getY(5)}" font-size="3" fill="#999">5</text>
                    <text x="0" y="${getY(0)}" font-size="3" fill="#999">0</text>
                </svg>
            `;

            container.innerHTML = svgContent;
            modal.showModal();
        }

        // Inicializar la aplicaci√≥n
        initApp();

        // Manejo de instalaci√≥n PWA
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que Chrome muestre su propio banner
            e.preventDefault();
            // Guardar el evento para usarlo despu√©s
            deferredPrompt = e;
            // Mostrar nuestro banner personalizado
            installPrompt.classList.add('show');
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            // Mostrar el prompt de instalaci√≥n
            deferredPrompt.prompt();
            // Esperar la respuesta del usuario
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Usuario ${outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
            // Limpiar el prompt
            deferredPrompt = null;
            // Ocultar el banner
            installPrompt.classList.remove('show');
        });

        // Detectar si la app ya est√° instalada
        window.addEventListener('appinstalled', () => {
            console.log('PWA instalada exitosamente');
            installPrompt.classList.remove('show');
            deferredPrompt = null;
        });

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/behavioral-activation/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registrado con √©xito:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }

        // Detecci√≥n de estado de conexi√≥n
        window.addEventListener('online', () => {
            document.body.classList.remove('offline-mode');
            console.log('Conexi√≥n restaurada');
        });

        window.addEventListener('offline', () => {
            document.body.classList.add('offline-mode');
            console.log('Sin conexi√≥n - modo offline');
        });
    </script>
</body>

</html>